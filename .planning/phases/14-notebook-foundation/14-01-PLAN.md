---
phase: 14-notebook-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - playground/quantization.py
  - playground/utils/__init__.py
  - playground/utils/model_loader.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "User can run `marimo edit playground/quantization.py` and see notebook interface"
    - "User can select model folder via file picker dialog"
    - "Models load with caching to prevent memory leak on re-run"
  artifacts:
    - path: "playground/quantization.py"
      provides: "Marimo notebook entry point"
      contains: "import marimo as mo"
    - path: "playground/utils/model_loader.py"
      provides: "Cached model loading for ONNX and PyTorch"
      contains: "@mo.cache"
    - path: "requirements.txt"
      provides: "Dependencies including marimo"
      contains: "marimo"
  key_links:
    - from: "playground/quantization.py"
      to: "playground/utils/model_loader.py"
      via: "import statement"
      pattern: "from.*model_loader import"
---

<objective>
Create Marimo notebook foundation with model loading utilities that cache ONNX and PyTorch models to prevent memory leaks on cell re-execution.

Purpose: Establish the interactive notebook infrastructure that enables safe, cached model loading for quantization experiments. The caching pattern is critical to avoid ONNX Runtime memory leak issues documented in research.

Output:
- `playground/quantization.py` - Marimo notebook with file picker and model loading cells
- `playground/utils/model_loader.py` - Cached model loading functions
- Updated `requirements.txt` with marimo dependency
</objective>

<execution_context>
@/home/impactaky/shelffiles/config/claude/get-shit-done/workflows/execute-plan.md
@/home/impactaky/shelffiles/config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-notebook-foundation/14-CONTEXT.md
@.planning/phases/14-notebook-foundation/14-RESEARCH.md
@scripts/extract_operations.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add marimo dependency and create notebook skeleton</name>
  <files>
    requirements.txt
    playground/quantization.py
    playground/utils/__init__.py
  </files>
  <action>
1. Update requirements.txt to add marimo dependency:
   - Add `marimo>=0.15.5` to requirements.txt

2. Create playground directory structure:
   - `playground/` directory
   - `playground/utils/` directory
   - `playground/utils/__init__.py` (empty or with `from .model_loader import *`)

3. Create playground/quantization.py as a Marimo notebook with initial cells:
   - Cell 1: Imports (marimo, pathlib, utils)
   - Cell 2: Header markdown with instructions ("Select a model folder to begin")
   - Cell 3: File picker widget using `mo.ui.file_browser(initial_path="./models", selection_mode="directory", multiple=False, label="Select model folder")`
   - Cell 4: Conditional display - show model folder path when selected, or instructions when not

Follow Marimo notebook format:
- Each cell is a Python function decorated with `@app.cell`
- First cell typically has `app = marimo.App()` assignment
- Use `mo.md()` for markdown rendering
- Return UI elements to display them
  </action>
  <verify>
Run: `cd /var/tmp/vibe-kanban/worktrees/8ac8-gsd-discuss-phas/resnet8 && python -c "import marimo; print('marimo version:', marimo.__version__)"` (install first if needed with `pip install marimo>=0.15.5`)
Run: `ls -la playground/` confirms directory structure exists
Run: `head -30 playground/quantization.py` shows valid marimo notebook structure
  </verify>
  <done>
- requirements.txt contains `marimo>=0.15.5`
- playground/quantization.py exists as valid Marimo notebook with file picker cell
- playground/utils/__init__.py exists
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cached model loading utilities</name>
  <files>
    playground/utils/model_loader.py
  </files>
  <action>
Create playground/utils/model_loader.py with cached model loading functions:

1. `load_onnx_model(path)` decorated with `@mo.cache`:
   - Takes Path or str to ONNX file
   - Returns loaded onnx.ModelProto via `onnx.load()`
   - Handles FileNotFoundError with clear message

2. `load_pytorch_model(path)` decorated with `@mo.cache`:
   - Takes Path or str to PyTorch file (.pt)
   - Returns loaded model via `torch.load()` with `weights_only=False` (needed for quantized models)
   - Sets model to eval mode
   - Handles FileNotFoundError with clear message

3. `load_model_variants(folder_path)` decorated with `@mo.cache`:
   - Takes folder path containing model variants
   - Looks for: resnet8.onnx (float), resnet8_int8.onnx, resnet8_uint8.onnx
   - Also looks for: resnet8.pt (float), resnet8_int8.pt
   - Returns dict with keys: 'onnx_float', 'onnx_int8', 'onnx_uint8', 'pytorch_float', 'pytorch_int8'
   - Value is None for missing files (don't error, just skip)
   - Logs which models were found

4. `get_model_summary(models_dict)`:
   - Takes the dict from load_model_variants
   - Returns dict with:
     - 'total_loaded': count of non-None models
     - 'onnx_available': list of available ONNX variants
     - 'pytorch_available': list of available PyTorch variants

Critical: Use `@mo.cache` decorator (not functools.lru_cache) for Marimo integration. This prevents ONNX Runtime memory leaks documented in research.

Import requirements at top:
```python
import marimo as mo
import onnx
import torch
from pathlib import Path
from typing import Dict, Optional, Any
```
  </action>
  <verify>
Run: `cd /var/tmp/vibe-kanban/worktrees/8ac8-gsd-discuss-phas/resnet8 && python -c "from playground.utils.model_loader import load_model_variants, get_model_summary; print('Import successful')"`
Run: `grep -c "@mo.cache" playground/utils/model_loader.py` shows at least 3 cache decorators
  </verify>
  <done>
- playground/utils/model_loader.py exists with @mo.cache decorated functions
- load_onnx_model, load_pytorch_model, load_model_variants, get_model_summary are importable
- Functions handle missing files gracefully (return None, don't crash)
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire model loading into notebook with spinner</name>
  <files>
    playground/quantization.py
  </files>
  <action>
Update playground/quantization.py to add model loading cells:

1. Add import for model_loader utilities at top:
   ```python
   from playground.utils.model_loader import load_model_variants, get_model_summary
   ```

2. Add model loading cell that:
   - Checks if folder_picker.value is truthy (folder selected)
   - Uses `mo.status.spinner(title="Loading models...")` as context manager
   - Calls `load_model_variants(folder_picker.path(0))` inside spinner
   - Catches exceptions and displays inline error with `mo.md(...).callout(kind="danger")`
   - On success, stores models and displays summary via `mo.md(...).callout(kind="success")`

3. Add model summary display cell that shows:
   - Model folder path
   - Count of loaded models
   - List of available ONNX variants
   - List of available PyTorch variants
   - Uses `mo.vstack()` for vertical layout

4. Initial state (before model load):
   - Show instructions text: "Select a model folder to begin"
   - Per CONTEXT.md decision: minimal with whitespace

Follow Marimo patterns from RESEARCH.md:
- Return UI elements from cells to display them
- Use conditional rendering based on state
- Don't mutate objects across cells
  </action>
  <verify>
Run: `cd /var/tmp/vibe-kanban/worktrees/8ac8-gsd-discuss-phas/resnet8 && python -c "exec(open('playground/quantization.py').read())"` - should not error (syntax check)
Run: `grep "mo.status.spinner" playground/quantization.py` confirms spinner usage
Run: `grep "load_model_variants" playground/quantization.py` confirms integration with loader
  </verify>
  <done>
- playground/quantization.py imports and uses model_loader utilities
- Notebook shows spinner during model loading
- Notebook displays model summary after successful load
- Notebook shows inline error message on load failure
- Notebook shows instructions before any model is loaded
  </done>
</task>

</tasks>

<verification>
1. Install dependencies: `pip install marimo>=0.15.5`
2. Launch notebook: `marimo edit playground/quantization.py`
3. Verify file picker appears and allows folder selection
4. Select models/ folder (requires ONNX models to exist - run conversion scripts if needed)
5. Verify spinner appears during loading
6. Verify model summary appears after load showing available variants
</verification>

<success_criteria>
- `marimo edit playground/quantization.py` opens without errors
- File picker UI is visible and functional
- Model loading uses @mo.cache (verify in source)
- Loading spinner appears during model load
- Model summary displays after successful load
- No memory growth on repeated folder selection (caching works)
</success_criteria>

<output>
After completion, create `.planning/phases/14-notebook-foundation/14-01-SUMMARY.md`
</output>
