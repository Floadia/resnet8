---
phase: 15-parameter-inspection
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - playground/quantization.py
autonomous: false

must_haves:
  truths:
    - "User can see whole-model heatmap showing FP32 and INT8 weight ranges side-by-side at the top of the notebook"
    - "User can view scale, zero-point, weight shape, and dtype for selected layer in a formatted table"
    - "User can see FP32 vs INT8 (and optionally UINT8) weight distribution histograms side-by-side for selected layer"
    - "Heatmap visually highlights layers with widest weight ranges (potential quantization trouble spots)"
    - "Histograms use consistent binning across FP32/INT8/UINT8 for valid visual comparison"
    - "Layers without quantization parameters show informative message instead of empty charts"
  artifacts:
    - path: "playground/quantization.py"
      provides: "Complete parameter inspection notebook with heatmap, table, and histogram cells"
      contains: "plt.subplots"
  key_links:
    - from: "playground/quantization.py (heatmap cell)"
      to: "compute_all_layer_ranges"
      via: "function call with fp32 and int8 models"
      pattern: "compute_all_layer_ranges"
    - from: "playground/quantization.py (table cell)"
      to: "extract_layer_params"
      via: "function call reactive to layer_selector.value"
      pattern: "extract_layer_params.*layer_selector"
    - from: "playground/quantization.py (histogram cell)"
      to: "extract_weight_tensors"
      via: "function call reactive to layer_selector.value"
      pattern: "extract_weight_tensors.*layer_selector"
---

<objective>
Add the three visualization sections to the Marimo notebook: whole-model heatmap overview, per-layer parameter table, and FP32 vs quantized weight histograms.

Purpose: This completes the parameter inspection UI. Users get a top-down workflow: see the whole-model overview (heatmap), select a layer of interest (dropdown from Plan 01), then drill into details (table + histograms).

Output: Updated `playground/quantization.py` with all visualization cells wired to the extraction utilities from Plan 01.
</objective>

<execution_context>
@/home/impactaky/shelffiles/config/claude/get-shit-done/workflows/execute-plan.md
@/home/impactaky/shelffiles/config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-parameter-inspection/parameter-inspection-CONTEXT.md
@.planning/phases/15-parameter-inspection/15-RESEARCH.md
@.planning/phases/15-parameter-inspection/15-01-SUMMARY.md

# Source files
@playground/quantization.py
@playground/utils/parameter_inspector.py
@playground/utils/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add whole-model heatmap and per-layer detail cells to notebook</name>
  <files>playground/quantization.py</files>
  <action>
Add new Marimo cells to `playground/quantization.py` implementing the full parameter inspection UI. The notebook layout (top to bottom) should be:

**Existing cells (do not modify):**
- Import cell
- Header cell
- File picker cell
- Model loading cell
- Model status display cell

**NEW - Heatmap overview section (insert ABOVE the layer dropdown):**

1. **Heatmap computation cell**: When models are loaded, call `compute_all_layer_ranges(models.get("onnx_float"), models.get("onnx_int8"))`. Store result as `layer_ranges`. Only compute if both onnx_float and onnx_int8 are available; if not, set `layer_ranges = None`.

2. **Heatmap visualization cell**: If `layer_ranges` is not None and not empty, create a matplotlib figure with `fig, (ax_fp32, ax_int8) = plt.subplots(1, 2, figsize=(14, max(6, len(layer_ranges) * 0.35)))`.
   - Left subplot: FP32 weight ranges as horizontal bars. Each row = one layer. Bar spans from min to max weight value. Color bars using `plt.cm.viridis` based on range magnitude (wider range = darker color).
   - Right subplot: INT8 (dequantized) weight ranges, same layout.
   - Y-axis: layer names (shortened if needed for readability).
   - X-axis: weight value.
   - Title: "FP32 Weight Ranges" and "INT8 Weight Ranges (Dequantized)".
   - Use `plt.tight_layout()`.
   - Close previous figures with `plt.close('all')` BEFORE creating the new figure to prevent memory leaks.
   - Return the figure object (not axes) -- Marimo renders figure objects from cells.
   - If `layer_ranges` is None, display `mo.md("Load ONNX float and int8 models to see weight range heatmap.").callout(kind="info")` instead.

**Existing cells (keep as-is):**
- Layer name extraction cell (enhanced in Plan 01)
- Layer dropdown cell (enhanced in Plan 01)
- Layer dropdown display cell
- Layer info display cell
- Layer info render cell

**NEW - Per-layer detail section (insert BELOW the existing layer info cells):**

3. **Parameter extraction cell**: Reactive to `layer_selector.value`. When a layer is selected and `models.get("onnx_int8")` exists, call `extract_layer_params(models["onnx_int8"], layer_selector.value)`. Store as `layer_params`. Set to None if no layer selected or no onnx_int8 model.

4. **Parameter table cell**: If `layer_params` is not None, create a formatted table using `mo.ui.table` or `mo.md` with a markdown table. Display:
   - Scale: If per-channel (`is_per_channel` is True), show "min=X, max=Y, mean=Z" with 6 decimal places. If per-tensor, show the scalar value with 6 decimal places.
   - Zero-point: Show the integer value(s). Same per-channel summary treatment.
   - Weight shape: Show the tensor shape tuple (e.g., "(16, 3, 3, 3)").
   - Weight dtype: Show "int8", "uint8", or "float32".
   - Node type: "QuantizeLinear" or "DequantizeLinear".
   If `layer_params` is None and a layer is selected, show "No quantization parameters for this layer" callout.

5. **Weight histogram cell**: Reactive to `layer_selector.value`. When a layer is selected, call `extract_weight_tensors(models.get("onnx_float"), models.get("onnx_int8"), layer_selector.value, models.get("onnx_uint8"))`. If any weights returned are not None:
   - Count available weight variants (fp32, int8_dequantized, uint8_dequantized).
   - Create `fig, axes = plt.subplots(1, num_variants, figsize=(5 * num_variants, 4))`.
   - Determine consistent bin range across ALL available weight arrays: `bin_range = (global_min, global_max)`. Use `bins=50`.
   - Plot each available variant as a histogram with consistent `bins=50` and `range=bin_range`.
   - Labels: "FP32 Weights", "INT8 (Dequantized)", "UINT8 (Dequantized)".
   - X-axis: "Weight Value". Y-axis: "Count".
   - `plt.close('all')` BEFORE creating the new figure.
   - `plt.tight_layout()`.
   - Return the figure object.
   - If no weights available, display "No weight tensors found for this layer" callout.
   - If no layer selected, display nothing (empty cell).

**Important implementation notes:**
- ALWAYS call `plt.close('all')` before creating new figures to prevent memory leaks.
- NEVER call `plt.show()` -- return the figure object for Marimo to render.
- Use `import matplotlib.pyplot as plt` and `import numpy as np` in the import cell (add to existing imports).
- Each new cell must declare its dependencies via function parameters (Marimo's reactivity model).
- For cells that need `models`, `layer_selector`, and utility functions, reference them as cell function parameters.
- Handle the case where ONNX models are not loaded (show informative callouts).
  </action>
  <verify>
Run `ruff check playground/quantization.py` to verify no lint errors.
Verify that:
- The notebook has cells for: heatmap computation, heatmap display, parameter extraction, parameter table, weight histograms.
- All plt calls are preceded by `plt.close('all')`.
- No `plt.show()` calls exist.
- Consistent binning: histogram cells use shared `range` and `bins=50`.
- Cells reference `layer_selector.value` for reactivity.
  </verify>
  <done>
Notebook contains heatmap overview (above dropdown) and per-layer detail section (below dropdown) with parameter table and weight histograms. All visualization cells use matplotlib, handle missing data gracefully, and prevent memory leaks.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete parameter inspection notebook with whole-model heatmap, enhanced layer dropdown with [Q] indicators, per-layer parameter table, and FP32 vs INT8 weight distribution histograms.</what-built>
  <how-to-verify>
1. Run `marimo edit playground/quantization.py` from the project root.
2. Select a model file from the models/ directory (need resnet8.onnx, resnet8_int8.onnx -- regenerate with `python scripts/quantize_onnx.py` if missing, and ensure resnet8.onnx exists from `python scripts/convert.py`).
3. Verify the heatmap overview appears at the top showing FP32 and INT8 weight ranges side-by-side. Layers with wider ranges should be visually more prominent (darker bars).
4. Verify the layer dropdown shows "[Q]" indicators next to layers with quantization parameters.
5. Select a layer WITH "[Q]" indicator. Verify:
   - Parameter table shows scale, zero-point, weight shape, dtype.
   - Weight histograms show FP32 on left, INT8 on right (and UINT8 if available) with consistent x-axis ranges.
6. Select a layer WITHOUT "[Q]" indicator. Verify:
   - "No quantization parameters" message appears instead of table.
   - Histogram shows FP32 weights if available, or appropriate message if not.
7. Check that changing the selected layer updates all detail views reactively (no manual re-run needed).
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix.</resume-signal>
</task>

</tasks>

<verification>
1. `ruff check playground/quantization.py` passes
2. Notebook loads without errors in `marimo edit`
3. Heatmap renders with FP32 and INT8 side-by-side bar charts
4. Layer dropdown has "[Q]" markers on quantized layers
5. Parameter table displays scale, zero-point, shape, dtype for selected layer
6. Histograms use consistent binning (same x-axis range across FP32/INT8/UINT8)
7. Memory stable: switching layers multiple times does not grow memory (plt.close works)
8. Layers without params show graceful "no parameters" message
</verification>

<success_criteria>
- INSP-01: User can view scale and zero-point for any selected layer -- SATISFIED by parameter table
- INSP-02: User can view weight tensor shapes and dtypes -- SATISFIED by parameter table
- INSP-03: User can navigate model structure via dropdown and drill into any layer -- SATISFIED by enhanced dropdown with [Q] indicators (reuses Phase 14 dropdown)
- INSP-04: User can see FP32 vs quantized weight values side-by-side -- SATISFIED by weight histograms
- INSP-05: User can view activation histogram showing distribution of values per layer -- SATISFIED by weight distribution histograms (weight values = static activations stored in model)
- Whole-model heatmap overview shows which layers have widest ranges
- All visualizations update reactively when layer selection changes
</success_criteria>

<output>
After completion, create `.planning/phases/15-parameter-inspection/15-02-SUMMARY.md`
</output>
