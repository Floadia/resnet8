---
phase: 01-model-conversion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/convert.py
  - models/.gitkeep
  - logs/.gitkeep
autonomous: true

must_haves:
  truths:
    - "ONNX file exists at models/resnet8.onnx after running conversion"
    - "Conversion logs show successful tf2onnx execution without errors"
    - "ONNX model has input shape (batch, 32, 32, 3) for CIFAR-10 images"
    - "ONNX model has output shape (batch, 10) for 10 CIFAR-10 classes"
    - "onnx.checker.check_model() passes without errors"
  artifacts:
    - path: "scripts/convert.py"
      provides: "Keras to ONNX conversion with logging"
      contains: "tf2onnx.convert.from_keras"
    - path: "models/resnet8.onnx"
      provides: "Converted ONNX model file"
    - path: "logs/conversion.log"
      provides: "Conversion progress and warnings"
  key_links:
    - from: "scripts/convert.py"
      to: "/mnt/ext1/references/tiny/benchmark/training/image_classification/trained_models/pretrainedResnet.h5"
      via: "tf.keras.models.load_model"
      pattern: "load_model.*pretrainedResnet"
    - from: "scripts/convert.py"
      to: "models/resnet8.onnx"
      via: "tf2onnx.convert.from_keras output_path"
      pattern: "output_path.*resnet8\\.onnx"
    - from: "scripts/convert.py"
      to: "onnx.checker"
      via: "Model validation after conversion"
      pattern: "onnx\\.checker\\.check_model"
---

<objective>
Convert the pretrained Keras ResNet8 model to ONNX format and verify the converted model has correct structure.

Purpose: Create a valid ONNX model that can be evaluated in Phase 2 using ONNX Runtime. The conversion must preserve model structure and produce a model that passes ONNX validation.

Output:
- scripts/convert.py (conversion script with logging)
- models/resnet8.onnx (converted model)
- logs/conversion.log (conversion progress and any warnings)
</objective>

<execution_context>
@/home/impactaky/shelffiles/config/claude/get-shit-done/workflows/execute-plan.md
@/home/impactaky/shelffiles/config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-model-conversion/01-RESEARCH.md

Source Keras model location:
/mnt/ext1/references/tiny/benchmark/training/image_classification/trained_models/pretrainedResnet.h5
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project structure and conversion script</name>
  <files>
    scripts/convert.py
    models/.gitkeep
    logs/.gitkeep
  </files>
  <action>
Create the project directory structure:
- scripts/ - for Python scripts
- models/ - for ONNX output (with .gitkeep)
- logs/ - for conversion logs (with .gitkeep)

Create scripts/convert.py following the patterns from 01-RESEARCH.md:

1. Setup logging with both file (logs/conversion.log) and console handlers
2. Load Keras model from /mnt/ext1/references/tiny/benchmark/training/image_classification/trained_models/pretrainedResnet.h5
3. Define input_signature as [tf.TensorSpec([None, 32, 32, 3], tf.float32, name='input')] for CIFAR-10
4. Convert using tf2onnx.convert.from_keras() with opset=15, output_path='models/resnet8.onnx'
5. Verify with onnx.checker.check_model()
6. Log model structure: input name/shape, output name/shape, node count, parameter count
7. Print verification summary showing shapes match expectations

Use the complete conversion script pattern from RESEARCH.md as the base, adapting paths:
- keras_path: absolute path to pretrainedResnet.h5
- onnx_path: models/resnet8.onnx (relative, script runs from project root)
- log_file: logs/conversion.log

Include shape verification that checks:
- Input shape has spatial dims (32, 32, 3)
- Output shape has 10 classes
  </action>
  <verify>
Run: python scripts/convert.py

Expected output:
- No errors during execution
- logs/conversion.log created with INFO messages
- models/resnet8.onnx file created
- Console shows "Model verification passed" and shape information
  </verify>
  <done>
- scripts/convert.py exists and is executable
- models/ and logs/ directories exist
- Running the script produces models/resnet8.onnx
- Conversion completes without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Run conversion and verify ONNX model structure</name>
  <files>
    models/resnet8.onnx
    logs/conversion.log
  </files>
  <action>
Execute the conversion script and validate the results:

1. Run: python scripts/convert.py
2. Verify models/resnet8.onnx was created and has non-zero size
3. Verify logs/conversion.log contains conversion progress
4. Check the log for any warnings (especially BatchNorm-related)
5. Verify input shape in log shows (None, 32, 32, 3) or (1, 32, 32, 3)
6. Verify output shape in log shows (None, 10) or (1, 10)

If conversion fails:
- Check logs/conversion.log for error details
- Common fixes: ensure TensorFlow and tf2onnx are installed, check Keras model path is correct

After successful conversion, perform additional verification:
- Load the ONNX model with onnx.load()
- Re-run onnx.checker.check_model() as sanity check
- Print node count and parameter count to verify model was fully converted
  </action>
  <verify>
Run these checks:

```bash
# Check file exists and has content
ls -la models/resnet8.onnx

# Check log exists
cat logs/conversion.log

# Quick ONNX validation
python -c "import onnx; m = onnx.load('models/resnet8.onnx'); onnx.checker.check_model(m); print('Valid ONNX model')"
```

Expected:
- models/resnet8.onnx size > 100KB (model has weights)
- logs/conversion.log shows INFO messages for each step
- Python validation prints "Valid ONNX model"
  </verify>
  <done>
- models/resnet8.onnx exists with size > 100KB
- onnx.checker.check_model() passes
- Logged input shape matches (batch, 32, 32, 3)
- Logged output shape matches (batch, 10)
- No conversion errors in log (warnings acceptable)
  </done>
</task>

</tasks>

<verification>
Phase 1 success criteria from ROADMAP.md:

1. ONNX file exists at expected path after running conversion script
   - Check: ls models/resnet8.onnx

2. Conversion script logs show successful tf2onnx execution without errors
   - Check: grep -i error logs/conversion.log (should find nothing)
   - Check: grep "verification passed" logs/conversion.log

3. ONNX model has correct input shape (1, 32, 32, 3), output shape (1, 10), and expected layer count
   - Check: Run verification script or python one-liner to inspect model

4. Any conversion warnings are logged for review
   - Check: grep -i warning logs/conversion.log (review but don't fail)
</verification>

<success_criteria>
- [ ] scripts/convert.py exists and runs without errors
- [ ] models/resnet8.onnx exists (file size > 100KB)
- [ ] onnx.checker.check_model() passes
- [ ] Input shape is (batch, 32, 32, 3) for CIFAR-10
- [ ] Output shape is (batch, 10) for 10 classes
- [ ] logs/conversion.log contains conversion progress
- [ ] No errors in conversion log (warnings acceptable for BatchNorm)
</success_criteria>

<output>
After completion, create `.planning/phases/01-model-conversion/01-01-SUMMARY.md`
</output>
